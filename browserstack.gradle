import groovy.json.JsonSlurper

/**
 * This task will delete all previously uploaded AppLive apps for the provided customId
 */
ext.deleteAppLiveWithCustomId = { customId ->
    def response = new ByteArrayOutputStream()
    exec {
        executable "curl";
        args "-u", "$rootProject.browserStackUser:$rootProject.browserStackKey", "-X",
                "GET", "https://api-cloud.browserstack.com/app-live/recent_apps/${customId}"
        standardOutput = response;
    }
    def json = new JsonSlurper().parseText(response.toString())
    if (!(json instanceof List<Map>)) {
        logger.lifecycle("[BROWSERSTACK] No apps to delete for customId[${customId}] response[${json}]")
        return
    }
    for (def app : (List<Map>) json) {
        if (!(app.containsKey("app_id"))) {
            continue
        }
        def appId = URLEncoder.encode("${app.app_id}", "UTF-8")
        logger.lifecycle("[BROWSERSTACK] Deleting app with customId[${customId}] and appId[${appId}]")
        exec {
            executable "curl"; args "-u", "$rootProject.browserStackUser:$rootProject.browserStackKey", "-X",
                    "DELETE", "https://api-cloud.browserstack.com/app-live/app/delete/${appId}"
        }
    }
}